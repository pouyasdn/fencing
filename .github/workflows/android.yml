name: ساخت APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: دریافت کد پروژه
        uses: actions/checkout@v3

      - name: نصب Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: نصب بسته‌های مورد نیاز
        run: |
          sudo apt-get update
          sudo apt-get install -y git zip unzip openjdk-17-jdk python3-pip \
              autoconf automake libtool m4 autopoint pkgconf gettext

      - name: نصب Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r21e
          add-to-path: false

      - name: تنظیم مسیر NDK
        run: |
          echo "APP_ANDROID_NDK_PATH=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

      - name: نصب کتابخانه‌های Python
        run: |
          pip install --upgrade pip
          pip install Cython kivy arabic_reshaper python-bidi buildozer

      - name: تنظیم مسیر aclocal و m4
        run: |
          echo "M4=/usr/bin/m4" >> $GITHUB_ENV
          echo "ACLOCAL=/usr/bin/aclocal" >> $GITHUB_ENV

      - name: ساخت APK با Buildozer
        run: buildozer android debug

      - name: ذخیره APK
        uses: actions/upload-artifact@v3
        with:
          name: apk
          path: '**/bin/*.apk'
